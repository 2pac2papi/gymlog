<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>GymLog Pro — Registro rápido</title>
  <meta name="theme-color" content="#0ea5a4">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b1215;--card:#0f1920;--muted:#9dc7d4;--text:#e8f2f6;--accent:#0ea5a4;--accent2:#14b8a6;--line:#14313b;--danger:#ef4444;--warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0f172a 0%, #0b1215 100%);padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    main{max-width:800px;margin:0 auto;padding:14px}
    .pill{border:1px solid #134e4a;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #1a2f35;background:#0d1518;color:var(--text);font-size:16px}
    input[type=number]{text-align:center}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid #0f766e;background:var(--accent);color:#05302d;font-weight:700;padding:12px 14px;border-radius:12px}
    .btn.secondary{background:#0d1518;color:var(--text)}
    .btn.ghost{background:transparent;border-color:#1f2f35;color:var(--muted)}
    .btn.small{padding:8px 10px;font-size:13px}
    .title{font-weight:700;margin:4px 0 10px}
    .nav{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .nav button{appearance:none;border:1px solid #134e4a;background:#0d1518;color:var(--text);padding:10px;border-radius:12px;font-weight:600}
    .nav button.active{background:var(--accent);border-color:#0d9488;color:#062c2a}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    .chipset{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px dashed #294a54;color:#b7dbe5;background:#0b1417;padding:6px 10px;border-radius:999px;font-size:13px}
    .shortcut .btn{min-width:54px}
    .timer{font-variant-numeric:tabular-nums;font-weight:700}
    canvas{width:100%;height:90px;background:#0b1417;border:1px solid #17323a;border-radius:10px}
    @media (max-width:560px){.grid-2,.grid-3{grid-template-columns:1fr} header h1{font-size:16px}}
  </style>
</head>
<body>
  <header>
    <h1>GymLog Pro</h1>
    <div class="row">
      <span class="pill" id="pill-days">Sesiones: 0</span>
      <span class="pill" id="pill-vol">Volumen hoy: 0</span>
      <span class="pill" id="pill-prs">PRs: 0</span>
    </div>
  </header>
  <main>
    <div class="nav">
      <button id="tab-reg" class="active">Registrar</button>
      <button id="tab-hist">Historial</button>
      <button id="tab-cfg">Config</button>
    </div>

    <!-- REGISTRAR -->
    <section id="view-reg" class="card">
      <div class="grid-2">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha" value="2025-09-01">
        </div>
        <div>
          <label>Grupo / Ejercicio</label>
          <input list="ej-dl" id="ej" placeholder="Press banca">
          <datalist id="ej-dl"></datalist>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div>
          <label>Peso (kg)</label>
          <input type="number" id="peso" step="0.5" inputmode="decimal">
        </div>
        <div>
          <label>Reps</label>
          <input type="number" id="reps" step="1" inputmode="numeric">
        </div>
        <div>
          <label>RPE</label>
          <input type="number" id="rpe" step="0.5" inputmode="decimal" placeholder="6-10">
        </div>
      </div>

      <div class="row shortcut" style="margin-top:8px">
        <button class="btn small" data-delta="peso:+2.5">+2.5kg</button>
        <button class="btn small" data-delta="peso:+5">+5kg</button>
        <button class="btn small" data-delta="peso:-2.5">-2.5kg</button>
        <button class="btn small" data-delta="reps:+1">+1 rep</button>
        <button class="btn small" data-delta="reps:-1">-1 rep</button>
        <button class="btn small" id="btn-copiar">Copiar serie</button>
      </div>

      <div style="margin-top:8px">
        <label>Notas</label>
        <textarea id="notas" placeholder="Agarre, tempo, técnica…"></textarea>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-guardar">Guardar</button>
        <button class="btn secondary" id="btn-guardar-otra">Guardar + otra</button>
        <button class="btn ghost" id="btn-limpiar">Limpiar</button>
        <span class="muted">Descanso: <span id="timer" class="timer">00:00</span></span>
        <button class="btn ghost small" id="btn-timer">▶︎</button>
        <button class="btn ghost small" id="btn-timer-reset">⟲</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="title">Tendencia (últimas 10 sesiones del ejercicio)</div>
        <canvas id="spark"></canvas>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="view-hist" class="card" style="display:none">
      <div class="grid-2">
        <div>
          <label>Ejercicio</label>
          <select id="f-ej"><option value="">Todos</option></select>
        </div>
        <div>
          <label>Desde</label>
          <input type="date" id="f-desde">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Hasta</label>
          <input type="date" id="f-hasta">
        </div>
        <div class="row" style="align-items:end">
          <button class="btn ghost" id="f-limpiar">Limpiar filtros</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-export">Exportar CSV</button>
        <button class="btn secondary" id="btn-backup">Copia (JSON)</button>
        <label for="restore" class="btn ghost">Restaurar</label>
        <input id="restore" type="file" accept="application/json" style="display:none">
      </div>
      <div class="title">Resumen</div>
      <div class="muted" id="resumen">—</div>
      <div class="title" style="margin-top:10px">Series</div>
      <div id="tabla"></div>
    </section>

    <!-- CONFIG -->
    <section id="view-cfg" class="card" style="display:none">
      <div class="title">Plantillas de ejercicios por día</div>
      <div class="chipset" id="chips"></div>
      <div class="grid-2" style="margin-top:10px">
        <div>
          <label>Añadir ejercicio</label>
          <input id="nuevo-ej" placeholder="Pecho · Press banca">
        </div>
        <div class="row" style="align-items:end">
          <button class="btn" id="btn-add-ej">+</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn warn" id="btn-prs">Recalcular PRs</button>
        <button class="btn danger" id="btn-wipe">Borrar TODO</button>
      </div>
      <p class="muted" style="margin-top:8px">Sugeridos: Pecho (press banca, inclinado, aperturas), Espalda (jalón, remo), Hombro (press, laterales), Pierna (sentadilla, prensa, femoral, gemelos).</p>
    </section>
  </main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS_DATA='gymlog_pro_data', LS_CFG='gymlog_pro_cfg';
  const DEF_EJ=[
    'Pecho · Press banca','Pecho · Press inclinado','Pecho · Aperturas máquina',
    'Espalda · Jalón al pecho','Espalda · Remo sentado','Espalda · Remo con barra',
    'Hombro · Press hombros','Hombro · Elevaciones laterales',
    'Pierna · Sentadilla','Pierna · Prensa 45°','Pierna · Curl femoral','Pierna · Gemelos',
    'Bíceps · Curl polea','Tríceps · Extensión polea','Core · Crunch máquina'
  ];

  // Storage
  const load = (k,def) => { try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(_){return def;} };
  const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  let data = load(LS_DATA, []);
  let cfg = load(LS_CFG, { ejercicios: DEF_EJ });

  // UI helpers
  function setTab(t){
    $$('#tab-reg,#tab-hist,#tab-cfg').forEach(b=>b.classList.remove('active'));
    $$('#view-reg,#view-hist,#view-cfg').forEach(v=>v.style.display='none');
    if(t==='reg'){ $('#tab-reg').classList.add('active'); $('#view-reg').style.display='block'; drawSpark(); }
    if(t==='hist'){ $('#tab-hist').classList.add('active'); $('#view-hist').style.display='block'; renderHist(); }
    if(t==='cfg'){ $('#tab-cfg').classList.add('active'); $('#view-cfg').style.display='block'; renderCfg(); }
  }

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function today(){ return (new Date()).toISOString().slice(0,10); }
  function fmt(d){ return new Date(d+'T00:00:00').toLocaleDateString('es-PE',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  function updatePills(){
    const days = new Set(data.map(r=>r.fecha));
    $('#pill-days').textContent='Sesiones: '+days.size;
    const hoy = today();
    const vol = data.filter(r=>r.fecha===hoy).reduce((a,r)=>a + Number(r.peso)*Number(r.reps),0);
    $('#pill-vol').textContent='Volumen hoy: '+vol.toFixed(0);
    const prs={};
    data.forEach(r=>{ const k=r.ej.toLowerCase(); prs[k]=Math.max(prs[k]||0, Number(r.peso)); });
    $('#pill-prs').textContent='PRs: '+Object.keys(prs).length;
  }

  function fillDatalist(){
    const dl=$('#ej-dl'); dl.innerHTML='';
    cfg.ejercicios.forEach(e=>{ const o=document.createElement('option'); o.value=e; dl.appendChild(o); });
    // filtros
    const sel=$('#f-ej'); sel.innerHTML='<option value="">Todos</option>' + Array.from(new Set(data.map(r=>r.ej))).sort().map(e=>`<option value="${e}">${e}</option>`).join('');
  }

  function guardar(keep){
    const fecha=$('#fecha').value || today();
    const ej=($('#ej').value||'').trim(); if(!ej) return alert('Elige/ingresa ejercicio');
    const peso=Number($('#peso').value); if(!(peso>0)) return alert('Peso inválido');
    const reps=Number($('#reps').value); if(!(reps>0)) return alert('Reps inválidas');
    const rpe=$('#rpe').value?Number($('#rpe').value):null;
    const notas=($('#notas').value||'').trim();
    data.push({id:uid(), fecha, ej, peso, reps, rpe, notas, ts:Date.now()});
    save(LS_DATA, data);
    if(keep){ $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; $('#reps').focus(); }
    else{ $('#ej').value=''; $('#peso').value=''; $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; }
    updatePills(); drawSpark(); if($('#view-hist').style.display==='block') renderHist();
  }

  // Sparkline canvas (últimas 10 sesiones por ejercicio)
  function drawSpark(){
    const c=$('#spark'); if(!c) return; const ctx=c.getContext('2d'); const w=c.width= c.clientWidth; const h=c.height=c.clientHeight;
    const name=($('#ej').value||'').trim(); if(!name){ ctx.clearRect(0,0,w,h); return; }
    const rows=data.filter(r=>r.ej===name).sort((a,b)=>a.fecha.localeCompare(b.fecha)).slice(-10);
    ctx.clearRect(0,0,w,h);
    if(rows.length===0) return;
    const xs=rows.map((_,i)=> i/(rows.length>1?rows.length-1:1));
    const ys=rows.map(r=>Number(r.peso));
    const min=Math.min(...ys), max=Math.max(...ys);
    function yv(v){ if(max===min) return h/2; return h - (v-min)/(max-min)*h; }
    ctx.beginPath();
    rows.forEach((r,i)=>{ const x=xs[i]*w; const y=yv(r.peso); if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y); });
    ctx.strokeStyle='#34d399'; ctx.lineWidth=2; ctx.stroke();
  }

  // Historial
  function renderHist(){
    fillDatalist();
    const fe=$('#f-ej').value||''; const d=$('#f-desde').value; const h=$('#f-hasta').value;
    let rows=data.slice();
    if(fe) rows=rows.filter(r=>r.ej===fe);
    if(d) rows=rows.filter(r=>r.fecha>=d);
    if(h) rows=rows.filter(r=>r.fecha<=h);
    rows.sort((a,b)=> a.fecha===b.fecha? b.ts-a.ts : (a.fecha<b.fecha?1:-1));
    const vol = rows.reduce((acc,r)=> acc + Number(r.peso)*Number(r.reps), 0);
    const dias = new Set(rows.map(r=>r.fecha)).size;
    $('#resumen').textContent = rows.length? `Series: ${rows.length} • Volumen: ${vol.toFixed(0)} • Días: ${dias}` : 'Sin datos para los filtros.';
    const wrap=$('#tabla');
    if(rows.length===0){ wrap.innerHTML='<div class="muted">—</div>'; return; }
    let html='<table class="table"><thead><tr><th>Fecha</th><th>Ejercicio</th><th>Peso</th><th>Reps</th><th>RPE</th><th>Notas</th><th></th></tr></thead><tbody>';
    html+=rows.map(r=>`<tr data-id="${r.id}"><td>${fmt(r.fecha)}</td><td>${r.ej}</td><td>${r.peso}</td><td>${r.reps}</td><td>${r.rpe??''}</td><td>${(r.notas||'').replace(/</g,'&lt;')}</td><td><button class="btn ghost small" data-act="edit">Editar</button> <button class="btn ghost small" data-act="del">Borrar</button></td></tr>`).join('');
    html+='</tbody></table>';
    wrap.innerHTML=html;
    wrap.querySelectorAll('button[data-act="del"]').forEach(b=>b.onclick=() => {
      const id=b.closest('tr').getAttribute('data-id');
      if(confirm('¿Eliminar registro?')){ data=data.filter(r=>r.id!==id); save(LS_DATA,data); renderHist(); updatePills(); }
    });
    wrap.querySelectorAll('button[data-act="edit"]').forEach(b=>b.onclick=() => {
      const id=b.closest('tr').getAttribute('data-id');
      const r=data.find(x=>x.id===id); if(!r) return;
      setTab('reg');
      $('#fecha').value=r.fecha; $('#ej').value=r.ej; $('#peso').value=r.peso; $('#reps').value=r.reps; $('#rpe').value=r.rpe??''; $('#notas').value=r.notas??'';
      data=data.filter(x=>x.id!==id); save(LS_DATA,data); updatePills();
    });
  }

  // Export/backup
  function toCSV(){
    const rows=[['fecha','ejercicio','peso_kg','reps','rpe','notas']].concat(data.map(r=>[r.fecha,r.ej,r.peso,r.reps,r.rpe??'',(r.notas||'').replace(/\n/g,' ')]));
    const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gymlog.csv'; a.click();
  }
  function backup(){
    const blob=new Blob([JSON.stringify({data,cfg,exportedAt:new Date().toISOString()})],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gymlog_backup.json'; a.click();
  }
  function restore(file){
    const fr=new FileReader(); fr.onload=()=>{ try{ const p=JSON.parse(fr.result); if(Array.isArray(p.data)) data=p.data; if(p.cfg) cfg=p.cfg; save(LS_DATA,data); save(LS_CFG,cfg); updatePills(); fillDatalist(); renderCfg(); renderHist(); alert('Restaurado'); }catch(_){ alert('Archivo inválido'); } }; fr.readAsText(file);
  }

  // Config
  function renderCfg(){
    const chips=$('#chips'); chips.innerHTML='';
    cfg.ejercicios.forEach((e,i)=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=e; s.title='Toca para eliminar'; s.onclick=()=>{ if(confirm('Eliminar "'+e+'"?')){ cfg.ejercicios.splice(i,1); save(LS_CFG,cfg); fillDatalist(); renderCfg(); } }; chips.appendChild(s); });
    fillDatalist();
  }

  // Timer
  let tStart=null, tInt=null;
  function tick(){
    const sec=Math.floor((Date.now()-tStart)/1000); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); $('#timer').textContent=m+':'+s;
  }

  // Bind
  $('#tab-reg').onclick=()=>setTab('reg');
  $('#tab-hist').onclick=()=>setTab('hist');
  $('#tab-cfg').onclick=()=>setTab('cfg');
  $('#btn-guardar').onclick=()=>guardar(false);
  $('#btn-guardar-otra').onclick=()=>guardar(true);
  $('#btn-limpiar').onclick=()=>{ $('#ej').value=''; $('#peso').value=''; $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; };
  $('#btn-export').onclick=toCSV;
  $('#btn-backup').onclick=backup;
  $('#restore').onchange=e=>e.target.files[0]&&restore(e.target.files[0]);
  $('#btn-add-ej').onclick=()=>{ const v=($('#nuevo-ej').value||'').trim(); if(!v) return; if(!cfg.ejercicios.includes(v)) cfg.ejercicios.push(v); $('#nuevo-ej').value=''; save(LS_CFG,cfg); renderCfg(); };
  $('#btn-wipe').onclick=()=>{ if(confirm('¿Borrar todo?')){ data=[]; save(LS_DATA,data); updatePills(); renderHist(); } };
  $('#btn-prs').onclick=()=>{ updatePills(); alert('PRs recalculados'); };
  $('#btn-copiar').onclick=()=>{ $('#reps').select(); };

  $$('.shortcut .btn').forEach(b=>b.onclick=()=>{ const d=b.getAttribute('data-delta'); if(!d) return; const [field,expr]=d.split(':'); const step=parseFloat(expr.replace('+','')); const neg=expr.startsWith('-'); const el=$('#'+field); let val=parseFloat(el.value||0); val = neg ? val - Math.abs(step) : val + step; el.value = (field==='reps') ? Math.max(0, Math.round(val)) : (Math.round(val*2)/2); });

  let tickInt=null;
  $('#btn-timer').onclick=()=>{ if(tStart) return; tStart=Date.now(); tick(); tickInt=setInterval(tick,250); };
  $('#btn-timer-reset').onclick=()=>{ clearInterval(tickInt); tickInt=null; tStart=null; $('#timer').textContent='00:00'; };

  // Init
  if(!$('#fecha').value) $('#fecha').value=today();
  renderCfg(); updatePills(); drawSpark();
})();
</script>
</body>
</html>
