<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>GymLog — Trainer Edition</title>
  <meta name="theme-color" content="#0ea5a4">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{ --bg:#0b1215; --card:#0f1920; --muted:#9dc7d4; --text:#e8f2f6; --accent:#0ea5a4; --line:#14313b; --danger:#ef4444; --ok:#22c55e; --info:#60a5fa; --warn:#f59e0b; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f172a 0%, #0b1215 100%);padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    main{max-width:900px;margin:0 auto;padding:14px}
    .pill{border:1px solid #134e4a;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .nav{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}
    .nav button{appearance:none;border:1px solid #134e4a;background:#0d1518;color:var(--text);padding:10px;border-radius:12px;font-weight:600}
    .nav button.active{background:var(--accent);border-color:#0d9488;color:#062c2a}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #1a2f35;background:#0d1518;color:var(--text);font-size:16px}
    input[type=number]{text-align:center}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid #0f766e;background:var(--accent);color:#05302d;font-weight:700;padding:12px 14px;border-radius:12px}
    .btn.secondary{background:#0d1518;color:var(--text)}
    .btn.ghost{background:transparent;border-color:#1f2f35;color:var(--muted)}
    .btn.small{padding:8px 10px;font-size:13px}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    canvas{width:100%;height:120px;background:#0b1417;border:1px solid #17323a;border-radius:10px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    @media (max-width:560px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>GymLog — Trainer Edition</h1>
    <div class="row">
      <span class="pill" id="pill-days">Sesiones: 0</span>
      <span class="pill" id="pill-vol">Volumen hoy: 0</span>
      <span class="pill" id="pill-prs">PRs: 0</span>
    </div>
  </header>
  <main>
    <div class="nav">
      <button id="tab-reg" class="active">Registrar</button>
      <button id="tab-hist">Historial</button>
      <button id="tab-prog">Progreso</button>
      <button id="tab-body">Cuerpo</button>
    </div>

    <!-- REGISTRAR -->
    <section id="view-reg" class="card">
      <div class="grid-2">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha" value="2025-09-01">
        </div>
        <div>
          <label>Ejercicio</label>
          <input list="ej-dl" id="ej" placeholder="Pecho · Press banca">
          <datalist id="ej-dl"></datalist>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div>
          <label>Peso (kg)</label>
          <input type="number" id="peso" step="0.5" inputmode="decimal">
        </div>
        <div>
          <label>Reps</label>
          <input type="number" id="reps" step="1" inputmode="numeric">
        </div>
        <div>
          <label>RPE (opcional)</label>
          <input type="number" id="rpe" step="0.5" inputmode="decimal" placeholder="6-10">
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Notas</label>
        <textarea id="notas" placeholder="Agarre, tempo, técnica…"></textarea>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-guardar">Guardar</button>
        <button class="btn secondary" id="btn-guardar-otra">Guardar + otra</button>
        <button class="btn ghost" id="btn-limpiar">Limpiar</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between;width:100%">
          <span class="muted">Tendencia del ejercicio (últimas 10 sesiones)</span>
          <span class="muted" id="spark-label">—</span>
        </div>
        <canvas id="spark"></canvas>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="view-hist" class="card" style="display:none">
      <div class="grid-2">
        <div>
          <label>Ejercicio</label>
          <select id="f-ej"><option value="">Todos</option></select>
        </div>
        <div>
          <label>Desde</label>
          <input type="date" id="f-desde">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Hasta</label>
          <input type="date" id="f-hasta">
        </div>
        <div class="row" style="align-items:end">
          <button class="btn ghost" id="f-limpiar">Limpiar filtros</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-export">Exportar CSV</button>
        <button class="btn secondary" id="btn-backup">Copia (JSON)</button>
        <label for="restore" class="btn ghost">Restaurar</label>
        <input id="restore" type="file" accept="application/json" style="display:none">
      </div>
      <div class="muted" id="resumen">—</div>
      <div style="margin:8px 0"><canvas id="weekchart"></canvas></div>
      <div id="tabla"></div>
    </section>

    <!-- PROGRESO -->
    <section id="view-prog" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="muted">Volumen semanal (últimas 10 semanas)</div>
        <div class="muted" id="week-label">—</div>
      </div>
      <canvas id="weektrend"></canvas>
      <div class="card" style="margin-top:10px">
        <div class="muted">Mejores marcas (PRs por ejercicio)</div>
        <div id="prs-list" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- CUERPO -->
    <section id="view-body" class="card" style="display:none">
      <div class="grid-3">
        <div>
          <label>Fecha</label>
          <input type="date" id="b-fecha" value="2025-09-01">
        </div>
        <div>
          <label>Peso corporal (kg)</label>
          <input type="number" id="b-peso" step="0.1" inputmode="decimal">
        </div>
        <div>
          <label>Altura (cm)</label>
          <input type="number" id="b-altura" step="0.1" inputmode="decimal" value="172">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-b-guardar">Guardar peso/IMC</button>
        <button class="btn ghost" id="btn-b-limpiar">Limpiar</button>
      </div>
      <div class="muted" id="b-msg">—</div>
      <div class="card" style="margin-top:10px">
        <div class="muted">Peso corporal e IMC (últimas 12 semanas)</div>
        <canvas id="bodytrend"></canvas>
      </div>
      <div id="body-table" style="margin-top:10px"></div>
    </section>
  </main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS_DATA='gl_data', LS_CFG='gl_cfg', LS_BODY='gl_body';

  const DEF_EJ=[
    'Pecho · Press banca','Pecho · Press inclinado','Espalda · Jalón al pecho','Espalda · Remo sentado',
    'Hombro · Press hombros','Hombro · Elevaciones laterales','Pierna · Sentadilla','Pierna · Prensa 45°','Pierna · Curl femoral','Pierna · Gemelos',
    'Bíceps · Curl polea','Tríceps · Extensión polea','Core · Crunch máquina'
  ];

  const load = (k,def) => { try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(_){return def;} };
  const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
  let data = load(LS_DATA, []);
  let cfg = load(LS_CFG, { ejercicios: DEF_EJ });
  let body = load(LS_BODY, []); // [{fecha, pesoKg, alturaCm, imc}]

  // Tabs
  $('#tab-reg').onclick=()=>setTab('reg');
  $('#tab-hist').onclick=()=>setTab('hist');
  $('#tab-prog').onclick=()=>setTab('prog');
  $('#tab-body').onclick=()=>setTab('body');

  function setTab(t){
    $$('#tab-reg,#tab-hist,#tab-prog,#tab-body').forEach(b=>b.classList.remove('active'));
    $$('#view-reg,#view-hist,#view-prog,#view-body').forEach(v=>v.style.display='none');
    if(t==='reg'){ $('#tab-reg').classList.add('active'); $('#view-reg').style.display='block'; drawSpark(); }
    if(t==='hist'){ $('#tab-hist').classList.add('active'); $('#view-hist').style.display='block'; renderHist(); }
    if(t==='prog'){ $('#tab-prog').classList.add('active'); $('#view-prog').style.display='block'; renderProg(); }
    if(t==='body'){ $('#tab-body').classList.add('active'); $('#view-body').style.display='block'; renderBody(); }
  }

  // Helpers
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function today(){ return (new Date()).toISOString().slice(0,10); }
  function fmt(d){ return new Date(d+'T00:00:00').toLocaleDateString('es-PE',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  function weekKey(d){ const dt=new Date(d+'T00:00:00'); const y=dt.getFullYear(); const jan1=new Date(y,0,1); const day=(dt-jan1)/86400000; const wk=Math.floor((day+jan1.getDay()+1)/7)+1; return y+'-W'+String(wk).padStart(2,'0'); }

  // Header pills
  function updatePills(){
    const days = new Set(data.map(r=>r.fecha));
    $('#pill-days').textContent='Sesiones: '+days.size;
    const vol = data.filter(r=>r.fecha===today()).reduce((a,r)=>a + Number(r.peso)*Number(r.reps),0);
    $('#pill-vol').textContent='Volumen hoy: '+vol.toFixed(0);
    const prs={}; data.forEach(r=>{ const k=r.ej.toLowerCase(); prs[k]=Math.max(prs[k]||0, Number(r.peso)); });
    $('#pill-prs').textContent='PRs: '+Object.keys(prs).length;
  }

  function fillEjDatalist(){
    const dl=$('#ej-dl'); dl.innerHTML=''; cfg.ejercicios.forEach(e=>{ const o=document.createElement('option'); o.value=e; dl.appendChild(o); });
    const sel=$('#f-ej'); sel.innerHTML='<option value="">Todos</option>' + Array.from(new Set(data.map(r=>r.ej))).sort().map(e=>`<option value="${e}">${e}</option>`).join('');
  }

  // Save set
  function guardar(keep){
    const fecha=$('#fecha').value||today();
    const ej=($('#ej').value||'').trim(); if(!ej) return alert('Elige/ingresa ejercicio');
    const peso=Number($('#peso').value); if(!(peso>0)) return alert('Peso inválido');
    const reps=Number($('#reps').value); if(!(reps>0)) return alert('Reps inválidas');
    const rpe=$('#rpe').value?Number($('#rpe').value):null;
    const notas=($('#notas').value||'').trim();
    data.push({id:uid(), fecha, ej, peso, reps, rpe, notas, ts:Date.now()});
    save(LS_DATA,data);
    if(keep){ $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; $('#reps').focus(); }
    else{ $('#ej').value=''; $('#peso').value=''; $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; }
    updatePills(); drawSpark(); if($('#view-hist').style.display==='block') renderHist(); if($('#view-prog').style.display==='block') renderProg();
  }
  $('#btn-guardar').onclick=()=>guardar(false);
  $('#btn-guardar-otra').onclick=()=>guardar(true);
  $('#btn-limpiar').onclick=()=>{ $('#ej').value=''; $('#peso').value=''; $('#reps').value=''; $('#rpe').value=''; $('#notas').value=''; };

  // Spark (exercise trend)
  function drawSpark(){
    const c=$('#spark'); if(!c) return; const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight;
    const name=($('#ej').value||'').trim(); $('#spark-label').textContent = name || '—';
    ctx.clearRect(0,0,w,h);
    if(!name) return;
    const rows=data.filter(r=>r.ej===name).sort((a,b)=>a.fecha.localeCompare(b.fecha)).slice(-10);
    if(!rows.length) return;
    const xs=rows.map((_,i)=> i/(rows.length>1?rows.length-1:1));
    const ys=rows.map(r=>Number(r.peso));
    const min=Math.min(...ys), max=Math.max(...ys);
    function yv(v){ if(max===min) return h/2; return h - (v-min)/(max-min)*h; }
    ctx.beginPath(); rows.forEach((r,i)=>{ const x=xs[i]*w; const y=yv(r.peso); if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y); });
    ctx.strokeStyle='#34d399'; ctx.lineWidth=2; ctx.stroke();
  }

  // History
  function renderHist(){
    fillEjDatalist();
    const fe=$('#f-ej').value||''; const d=$('#f-desde').value; const h=$('#f-hasta').value;
    let rows=data.slice();
    if(fe) rows=rows.filter(r=>r.ej===fe);
    if(d) rows=rows.filter(r=>r.fecha>=d);
    if(h) rows=rows.filter(r=>r.fecha<=h);
    rows.sort((a,b)=> a.fecha===b.fecha? b.ts-a.ts : (a.fecha<b.fecha?1:-1));
    const vol = rows.reduce((acc,r)=> acc + Number(r.peso)*Number(r.reps), 0);
    const dias = new Set(rows.map(r=>r.fecha)).size;
    $('#resumen').textContent = rows.length? `Series: ${rows.length} • Volumen: ${vol.toFixed(0)} • Días: ${dias}` : 'Sin datos para los filtros.';
    // table
    const wrap=$('#tabla');
    if(rows.length===0){ wrap.innerHTML='<div class="muted">—</div>'; } else {
      let html='<table class="table"><thead><tr><th>Fecha</th><th>Ejercicio</th><th>Peso</th><th>Reps</th><th>RPE</th><th>Notas</th></tr></thead><tbody>';
      html+=rows.map(r=>`<tr><td>${fmt(r.fecha)}</td><td>${r.ej}</td><td>${r.peso}</td><td>${r.reps}</td><td>${r.rpe??''}</td><td>${(r.notas||'').replace(/</g,'&lt;')}</td></tr>`).join('');
      html+='</tbody></table>'; wrap.innerHTML=html;
    }
    // week chart (filtered)
    const wc=$('#weekchart').getContext('2d'); const w=$('#weekchart').width=$('#weekchart').clientWidth; const hh=$('#weekchart').height=$('#weekchart').clientHeight;
    wc.clearRect(0,0,w,hh);
    const byW={}; rows.forEach(r=>{ const k=weekKey(r.fecha); byW[k]=(byW[k]||0)+Number(r.peso)*Number(r.reps); });
    const keys=Object.keys(byW).sort().slice(-10);
    if(keys.length){
      const vals=keys.map(k=>byW[k]); const max=Math.max(...vals)||1;
      wc.beginPath();
      keys.forEach((k,i)=>{ const x=(i/(keys.length-1))*w; const y=hh - (byW[k]/max)*hh; if(i) wc.lineTo(x,y); else wc.moveTo(x,y); });
      wc.strokeStyle='#60a5fa'; wc.lineWidth=2; wc.stroke();
    }
  }
  $('#f-ej').onchange=renderHist; $('#f-desde').onchange=renderHist; $('#f-hasta').onchange=renderHist; $('#f-limpiar').onclick=()=>{ $('#f-ej').value=''; $('#f-desde').value=''; $('#f-hasta').value=''; renderHist(); };

  // Progress (weekly trend + PRs)
  function renderProg(){
    const best={}; data.forEach(r=>{ const k=r.ej; best[k]=Math.max(best[k]||0, Number(r.peso)); });
    const prsDiv=$('#prs-list'); prsDiv.innerHTML = Object.keys(best).length? Object.entries(best).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`<div class="muted">${k}: <b>${v} kg</b></div>`).join('') : '<div class="muted">Aún sin PRs.</div>';
    const c=$('#weektrend'); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight;
    ctx.clearRect(0,0,w,h);
    const byW={}; data.forEach(r=>{ const k=weekKey(r.fecha); byW[k]=(byW[k]||0)+Number(r.peso)*Number(r.reps); });
    const keys=Object.keys(byW).sort().slice(-10); $('#week-label').textContent = keys.length? keys[0]+' → '+keys[keys.length-1] : '—';
    if(!keys.length) return;
    const vals=keys.map(k=>byW[k]); const max=Math.max(...vals)||1;
    ctx.beginPath();
    keys.forEach((k,i)=>{ const x=(i/(keys.length-1))*w; const y=h - (byW[k]/max)*h; if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y); });
    ctx.strokeStyle='#22c55e'; ctx.lineWidth=2; ctx.stroke();
  }

  // Body
  function renderBody(){
    const c=$('#bodytrend'); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight;
    ctx.clearRect(0,0,w,h);
    const rows=body.slice().sort((a,b)=>a.fecha.localeCompare(b.fecha)).slice(-12);
    if(rows.length){
      const xs=rows.map((_,i)=> i/(rows.length>1?rows.length-1:1));
      const ys=rows.map(r=>Number(r.pesoKg));
      const min=Math.min(...ys), max=Math.max(...ys);
      function yv(v){ if(max===min) return h/2; return h - (v-min)/(max-min)*h; }
      ctx.beginPath(); rows.forEach((r,i)=>{ const x=xs[i]*w; const y=yv(r.pesoKg); if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y); }); ctx.strokeStyle='#fbbf24'; ctx.lineWidth=2; ctx.stroke();
    }
    // table
    const wrap=$('#body-table');
    if(body.length===0){ wrap.innerHTML='<div class="muted">Aún no registras peso.'; }
    else {
      let html='<table class="table"><thead><tr><th>Fecha</th><th>Peso (kg)</th><th>IMC</th></tr></thead><tbody>';
      html+=body.slice().sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(r=>`<tr><td>${fmt(r.fecha)}</td><td>${r.pesoKg.toFixed(1)}</td><td>${r.imc.toFixed(1)}</td></tr>`).join('');
      html+='</tbody></table>'; wrap.innerHTML=html;
    }
  }
  function guardarBody(){
    const fecha=$('#b-fecha').value||today();
    const peso=parseFloat($('#b-peso').value); if(!(peso>0)) return alert('Peso inválido');
    const altCm=parseFloat($('#b-altura').value)||172;
    const imc = peso / Math.pow(altCm/100, 2);
    const wk=weekKey(fecha);
    const idx = body.findIndex(b=>weekKey(b.fecha)===wk);
    const rec={fecha, pesoKg:peso, alturaCm:altCm, imc};
    if(idx>=0) body[idx]=rec; else body.push(rec);
    save(LS_BODY, body);
    $('#b-msg').textContent='Guardado ('+fecha+'): '+peso.toFixed(1)+' kg, IMC '+imc.toFixed(1);
    $('#b-peso').value=''; renderBody();
  }
  $('#btn-b-guardar').onclick=guardarBody;
  $('#btn-b-limpiar').onclick=()=>{ $('#b-peso').value=''; $('#b-msg').textContent='—'; };

  // Export/Backup/Restore
  function toCSV(){
    const rows=[['fecha','ejercicio','peso_kg','reps','rpe','notas']].concat(data.map(r=>[r.fecha,r.ej,r.peso,r.reps,r.rpe??'',(r.notas||'').replace(/\n/g,' ')]));
    const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='gymlog_series.csv'; a.click();
  }
  function backup(){
    const payload={ data, cfg, body, exportedAt:new Date().toISOString() };
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload)],{type:'application/json'})); a.download='gymlog_backup.json'; a.click();
  }
  function restore(file){
    const fr=new FileReader(); fr.onload=()=>{ try{ const p=JSON.parse(fr.result); if(Array.isArray(p.data)) data=p.data; if(p.cfg) cfg=p.cfg; if(Array.isArray(p.body)) body=p.body; save(LS_DATA,data); save(LS_CFG,cfg); save(LS_BODY,body); alert('Restaurado'); updatePills(); fillEjDatalist(); renderHist(); renderProg(); renderBody(); }catch(_){ alert('Archivo inválido'); } }; fr.readAsText(file);
  }
  $('#btn-export').onclick=toCSV; $('#btn-backup').onclick=backup; $('#restore').onchange=e=>e.target.files[0]&&restore(e.target.files[0]);

  // Init
  function init(){
    if(!$('#fecha').value) $('#fecha').value=today();
    fillEjDatalist(); updatePills(); drawSpark(); renderProg();
  }
  init();
})();
</script>
</body>
</html>
